<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.web.app.mapper.InsPetitionsDataMapper">

    <resultMap id="BaseResultMap" type="com.web.app.domain.MosContentConfirm.IdPetitionUserId">
            <result property="id" column="id" jdbcType="VARCHAR"/>
            <result property="petitionUserId" column="petitionUserId" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="BaseResultMap2" type="com.web.app.domain.MosContentConfirm.UserLanguageIdPlatformId">
            <result property="languageId" column="LanguageId" jdbcType="VARCHAR"/>
            <result property="platformId" column="PlatformId" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="BaseResultMap3" type="com.web.app.domain.MosContentConfirm.IdPetitionUserId">
            <result property="extensionitemId" column="ExtensionitemId" jdbcType="VARCHAR"/>
            <result property="extensionitemValue" column="ExtensionitemValue" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- TBL「案件別個人情報リレーション（case_relations）」と「申立（case_petitions）」より用意した下書き保存データを取得する。 -->
    <select id="selectIdPetitionUserId" parameterType="string" resultMap="BaseResultMap">
        select b.id, 
            a.petitionUserId
        from 
            case_relations as a
        inner join
            case_petitions as b
        where
            a.petitionUserId = #{uid} and
            b.status = '0' and
            a.casePetition = b.id
    </select>

    <!-- TBL「案件別個人情報リレーション（case_relations）」の更新 -->
    <update id="updateCaseRelations" parameterType="com.web.app.domain.MosContentConfirm.UpdateCaseRelations">
        update  
            case_relations
        set 
            id = #{ id },
            CaseId = #{ caseId },
            PlatformId = #{ platformId },
            PetitionUserInfo_Email = #{ petitionUserInfoEmail },
            Agent1_Email = #{ agent1Email },
            Agent2_Email = #{ agent2Email },
            Agent3_Email = #{ agent3Email },
            Agent4_Email = #{ agent4Email },
            Agent5_Email = #{ agent5Email },
            TraderUserEmail = #{ traderUserEmail }
        where
            CasePetition = #{casePetitions} and
            PetitionUserId = #{petitionUserId}
    </update> 

    <!-- ユーザ情報の取得-->
    <select id="selectLanguageIdAndPlatformId" parameterType="string" resultMap="BaseResultMap2">
        select languageId, 
            platformId
        from 
            odr_users
        where
            uid = #{uid}
    </select>

    <!-- 販売者メールアドレス登録有無の判定-->
    <select id="selectCount" resultType="int">
        select count(*)
        from 
            odr_users
        where
            Email = #{email} and
            PlatformId = #{platformId} and
            DeleteFlag = #{deleteFlag}
    </select>

    <!-- TBL「案件（cases）」の新規登録 -->
    <insert id="insertCases" parameterType="com.web.app.domain.MosContentConfirm.InsertCases">
        insert into cases(
            cid,
            platformId,
            caseStage,
            caseStatus,
            caseTitle,
            petitionDate,
            languageId,
            replyStartDate,
            replyEndDate
        )
        values(
            #{cid},
            #{platformId},
            #{caseStage},
            #{caseStatus},
            #{caseTitle},
            #{petitionDate,},
            #{languageId},
            #{replyStartDate},
            #{replyEndDate}
        )
    </insert>

    <!-- 拡張項目内容の更新 -->
    <update id="updatecaseExtensionitemValues" parameterType="com.web.app.domain.MosContentConfirm.UpdateOrInsertCaseExtensionitemValues">
        update  
            case_extensionitem_values
        set 
            ExtensionitemValue,
            DeleteFlag,
            LastModifiedDate,
            LastModifiedBy,
            CaseId,
        where
            PlatformId = #{platformId}
            Case_petitionId = #{casePetitionId}
            DeleteFlag = #{deleteFlag0}
            ExtensionitemId = #{extensionitemId}
    </update> 

    <!-- TBL「案件別個人情報リレーション（case_relations）」の更新 -->
    <update id="updateCasePetitions" parameterType="com.web.app.domain.MosContentConfirm.UpdateCasePetitions">
        update  
            case_petitions
        set 
            PlatformId = #{platformId},
            CaseId = #{caseId},
            productName = #{productName},
            ProductId = #{productId},
            TraderName = #{traderName},
            TraderMail = #{traderMail},
            TraderUrl = #{traderUrl},
            BoughtDate = #{boughtDate},
            Price = #{price},
            petitionTypeValue = #{petitionTypeValue},
            petitionContext = #{petitionContext},
            ExpectResloveTypeValue = #{expectResloveTypeValue},
            Other = #{other}
            <!-- LanguageId = #{languageId} -->
        where
            id = #{id} 
    </update> 

    <!-- ユーザ情報を取得 -->
    <select id="selectFileId" resultType="string">
        select 
            a.fileId 
        from 
            case_file_relations as a
        inner join
            files as b
        where 
            a.RelationType = #{relationType} and
            a.RelatedId = #{relatedId} and
            a.fileId = b.id
    </select>

    <!-- TBL「案件-添付ファイルリレーション（case_file_relations）」を論理削除する -->
    <update id="updateDeleteFlag">
        update
            case_file_relations
        set
            DeleteFlag = #{deleteFlag}
        where
            id = #{id}
    </update>

    <!-- .TBL「案件-添付ファイルリレーション（case_file_relations）」を新規登録する -->
    <insert id="insertCaseFileRelations" parameterType="com.web.app.domain.MosContentConfirm.InsertCaseFileRelations">
        insert into case_file_relations(
            id,
            PlatformId,
            CaseId,
            RelationType,
            RelatedId,
            fileId,
            DeleteFlag,
            LastModifiedDate,
            LastModifiedBy
        )
        values(
            #{id},
            #{platformId},
            #{caseId},
            #{relationType},
            #{relatedId},
            #{fileId},
            #{deleteFlag},
            #{lastModifiedDate},
            #{lastModifiedBy}
        )
    </insert>

    <!-- TBL「添付ファイル（files）」を論理削除する -->
    <update id="updateDeleteFlag2">
        update
            files
        set
            DeleteFlag = #{deleteFlag}
        where
            id = #{fileId}
    </update>

    <!-- TBL「添付ファイル（files）」を新規登録する -->
    <insert id="insertFiles" parameterType="com.web.app.domain.MosContentConfirm.InsertFiles">
        insert into Files(
            id,
            PlatformId,
            CaseId,
            FileName,
            FileExtension,
            FileUrl,
            FileSize,
            RegisterUserId,
            RegisterDate,
            DeleteFlag,
            LastModifiedDate,
            LastModifiedBy
        )
        values(
            #{id},
            #{platformId},
            #{caseId},
            #{fileName},
            #{fileExtension},
            #{fileUrl},
            #{fileSize},
            #{registerUserId},
            #{registerDate},
            #{deleteFlag},
            #{lastModifiedDate},
            #{lastModifiedBy}
        )
    </insert>

    <!-- 拡張項目内容を取得 -->
    <select id="selectExtensionitemIdExtensionitemValue" resultMap="BaseResultMap3">
        select ExtensionitemId, 
            ExtensionitemValue
        from 
            case_extensionitem_values
        where
            PlatformId = #{platformId} and
            Case_petitionId = #{id} and
            DeleteFlag = #{deleteFlag0} and
            ExtensionitemId = #{extensionitemId}
    </select>

    <!-- case_extensionitem_valuesのMAX（id）を新規登録する -->
    <insert id="insertCaseExtensionitemValues" parameterType="com.web.app.domain.MosContentConfirm.UpdateOrInsertCaseExtensionitemValues">
        insert into case_extensionitem_values(
            id,
            PlatformId,
            CaseId,
            case_petitionId,
            ExtensionitemId,
            ExtensionitemValue,
            DeleteFlag,
            LastModifiedDate,
            LastModifiedBy
        )
        values(
            #{id},
            #{platformId},
            #{caseId},
            #{casePetitionId},
            #{extensionitemId},
            #{extensionitemValue},
            #{deleteFlag},
            #{lastModifiedDate},
            #{lastModifiedBy}
        )
    </insert>

    <!-- プラットフォームデータを取得 -->
    <select id="selectReplyLimitDays" resultMap="int">
        select 
            ReplyLimitDays
        from 
            master_platforms
        where
            Id = #{platformId} and
            DeleteFlag = #{deleteFlag} 
    </select>
</mapper>
